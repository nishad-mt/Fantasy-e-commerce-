{% extends "index.html" %}
{% load static %}

{% block title %}Order Details | Fantasy Bakery{% endblock %}

{% block content %}
<style>
@keyframes growLine {
    from { width: 0; }
    to { width: var(--progress); }
}

.progress-line {
    height: 4px;
    background: #e5e7eb;
    position: relative;
    border-radius: 9999px;
    overflow: hidden;
}

.progress-line-fill {
    height: 100%;
    background: linear-gradient(to right, #10b981, #22c55e);
    width: 0;
    animation: growLine 1.2s ease-out forwards;
}
</style>


<section class="bg-fantasy-cream min-h-screen pt-32 pb-20">
    <div class="max-w-5xl mx-auto px-4 space-y-8">

        <!-- PAGE HEADER -->
        <div class="flex flex-wrap justify-between items-center gap-4">
            <div>
                <h1 class="text-3xl font-serif font-bold text-fantasy-brown">
                    Order Details
                </h1>
                <p class="text-sm text-gray-500 mt-1">
                    Order ID: <span class="font-semibold">{{ order.order_id }}</span>
                </p>
            </div>

            <span class="px-4 py-1 rounded-full text-sm font-semibold bg-green-100 text-green-700">
                Delivered
            </span>
        </div>

<!-- ORDER TRACKING -->
<div class="bg-white rounded-2xl shadow-sm border p-6">
    <h2 class="font-bold text-lg text-fantasy-brown mb-6">
        Order Tracking
    </h2>

    <!-- Labels with Order Date -->
<div class="flex justify-between text-sm font-semibold text-gray-700 mb-3">
    <div class="text-left">
        <p>Placed</p>
        <p class="text-xs text-gray-400 font-normal">
            {{ order.created_at|date:"d M Y" }}
        </p>
    </div>

    <div class="text-center">
        <p>Confirmed</p>
    </div>

    <div class="text-center">
        <p>Packed</p>
    </div>

    <div class="text-right">
        <p>Delivered</p>
    </div>
</div>


    <!-- Progress Line -->
    <div class="progress-line mb-4">
        <div class="progress-line-fill" style="--progress:
                {% if order.status == 'PENDING' %}25%
                {% elif order.status == 'CONFIRMED' %}50%
                {% elif order.status == 'PACKED' %}75%
                {% elif order.status == 'DELIVERED' %}100%
                {% else %}0%
                {% endif %};">
        </div>
    </div>

    <!-- Status Dots -->
    <div class="flex justify-between">
        <div class="w-4 h-4 rounded-full
            {% if order.status in 'PENDING CONFIRMED PACKED DELIVERED' %}
                bg-green-500
            {% else %}
                bg-gray-300
            {% endif %}
        "></div>

        <div class="w-4 h-4 rounded-full
            {% if order.status in 'CONFIRMED PACKED DELIVERED' %}
                bg-green-500
            {% else %}
                bg-gray-300
            {% endif %}
        "></div>

        <div class="w-4 h-4 rounded-full
            {% if order.status in 'PACKED DELIVERED' %}
                bg-green-500
            {% else %}
                bg-gray-300
            {% endif %}
        "></div>

        <div class="w-4 h-4 rounded-full
            {% if order.status == 'DELIVERED' %}
                bg-green-500
            {% else %}
                bg-gray-300
            {% endif %}
        "></div>
    </div>

    {% if order.status == "DELIVERED" and order.delivered_at %}
    <p class="text-xs text-green-600 mt-4 font-semibold">
        ‚úÖ Delivered on {{ order.delivered_at|date:"d M Y, h:i A" }}
    </p>
{% endif %}


    {% if order.status == "CANCELLED" %}
        <div class="mt-4 p-3 bg-red-50 border border-red-200 text-red-700 text-sm rounded-lg">
            ‚ùå This order has been cancelled.
        </div>
    {% endif %}
</div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- ORDER ITEMS -->
        <div class="bg-white rounded-2xl shadow-sm border">
            <div class="p-6 border-b">
                <h2 class="font-bold text-lg text-fantasy-brown">
                    Ordered Items
                </h2>
            </div>
            {% for item in items %}
            <div class="divide-y">
                <div class="flex gap-4 p-6">
                    <img src="{{ item.variant.product.main_image.url }}"
                         class="w-24 h-24 rounded-xl object-cover border">

                    <div class="flex-1">
                        <h3 class="font-semibold text-gray-800">
                            {{ item.variant.product.name }}
                        </h3>
                        <p class="text-sm text-gray-500 mt-1">
                            Variant: {{ item.variant.size_name }}
                        </p>
                        <p class="text-sm text-gray-500">
                            Quantity: {{ item.quantity}}
                        </p>
                        <p class="font-bold text-fantasy-brown mt-2">
                            ‚Çπ{{ item.price }}
                        </p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- DELIVERY ADDRESS -->
         <div class="bg-white rounded-2xl shadow-sm border p-6">
                <h3 class="font-bold text-lg text-fantasy-brown mb-3">
                    Delivery Address
                </h3>

                <p class="font-semibold text-gray-800">
                    {{order.address.name}}
                </p>
                <p class="text-sm text-gray-600 mt-1 leading-relaxed">
                    {{ order.address.street }} <br>
                    {{ order.address.city }}, {{ order.address.state }} ‚Äì {{ order.address.pincode }} <br>
                    Phone: +91 {{ order.address.phone }}
                </p>
            </div>

        </div>

        <!-- PAYMENT -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

            <div class="bg-white rounded-2xl shadow-sm border p-6">
    <h4 class="font-bold text-lg text-fantasy-brown mb-3">Payment Details</h4>

    <div class="grid grid-cols-2 gap-4 text-sm">

        <div>
            <p class="text-gray-500">Payment Method</p>
            <p class="font-medium">
                {{ order.get_payment_method_display }}
            </p>
        </div>

        <div>
            <p class="text-gray-500">Payment Status</p>
            <p class="font-medium">
                {{ order.get_payment_status_display }}
            </p>
        </div>

        <div>
            <p class="text-gray-500">Paid On</p>
            <p class="font-medium">
                {% if order.paid_at %}
                    {{ order.paid_at|date:"d M Y, h:i A" }}
                {% else %}
                    ‚Äî
                {% endif %}
            </p>
        </div>

        {% if order.payment_status == "REFUNDED" %}
        <div>
            <p class="text-gray-500">Refund</p>
            <p class="font-medium text-green-600">
                Refunded to wallet
            </p>
        </div>
        {% endif %}

    </div>
</div>


            <!-- PAYMENT SUMMARY -->
            <div class="bg-white rounded-2xl shadow-sm border p-6">
                <h3 class="font-bold text-lg text-fantasy-brown mb-3">
                    Payment Summary
                </h3>

                <div class="space-y-2 text-sm">
                    <div class="flex justify-between text-gray-600">
                        <span>Items Total</span>
                        <span>‚Çπ{{ order.order_items_total }}</span>
                    </div>

                    <div class="flex justify-between text-gray-600">
                        <span>Delivery Charges</span>
                            {% if order.delivery_charge == 0 %}
                                <span class="text-green-600 font-semibold">FREE</span>
                            {% else %}
                                <span>‚Çπ{{ order.delivery_charge|floatformat:2 }}</span>
                            {% endif %}                    
                    </div>

                    <div class="flex justify-between text-green-600">
                        <span>Discount</span>
                        <span>- ‚Çπ0</span>
                    </div>

                    <div class="flex justify-between border-t pt-3 font-bold text-lg">
                        <span>Total</span>
                        <span class="text-fantasy-brown">
                            ‚Çπ{{ order.total_amount }}
                        </span>
                    </div>

                    <p class="text-xs text-gray-500 mt-2">
                        Payment Method: {{ order.get_payment_method_display }}
                    </p>
                </div>
            </div>

        </div>

       {% if order.status == 'PENDING' or order.status == 'CONFIRMED' %}
        <div class="flex flex-wrap gap-4">
            <button
                type="button"
                onclick="openCancelModal()" id="confirmBtn"
                class="px-6 py-2 rounded-lg border border-orange-500 text-orange-600 font-semibold hover:bg-orange-50">
                Cancel Request
            </button>
        </div>
        {% endif %}
    </div> 
</section>
<div id="cancelModal"
     class="fixed inset-0 hidden bg-black/50 z-50 items-center justify-center">

    <div class="bg-white rounded-xl p-6 w-full max-w-md">
        <h2 class="text-lg font-semibold mb-4">Cancel Order</h2>

        <form method="POST"
              action="{% url 'cancel_order_request' order.order_id %}">
            {% csrf_token %}

            <!-- Cancellation reasons -->
            <div class="space-y-2 mb-4">
                {% for value, label in order.CANCEL_REASONS %}
                <label class="flex items-center gap-2 text-sm">
                    <input type="radio"
                           name="cancel_reason"
                           value="{{ value }}"
                           required>
                    {{ label }}
                </label>
                {% endfor %}
            </div>

            <!-- ‚úÖ CLEAR INFO (NO SECOND CONFIRMATION) -->
            {% if order.payment_method == "ONLINE" and order.payment_status == "SUCCESS" %}
            <div class="bg-green-50 border border-green-200 text-green-700 text-sm p-3 rounded-lg mb-4">
                üí∞ If you cancel this order, <strong>‚Çπ{{ order.total_amount }}</strong>
                will be credited to your wallet.
            </div>
            {% else %}
            <div class="bg-gray-50 border border-gray-200 text-gray-600 text-sm p-3 rounded-lg mb-4">
                ‚ÑπÔ∏è This order will be cancelled.
            </div>
            {% endif %}

            <!-- Buttons -->
            <div class="flex justify-end gap-3">
                <button type="button"
                        onclick="closeCancelModal()"
                        class="px-4 py-2 rounded-lg border">
                    Back
                </button>

                <button type="submit"
                        class="px-4 py-2 rounded-lg bg-red-600 text-white">
                    Confirm Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function openCancelModal() {
    document.getElementById("cancelModal").classList.remove("hidden");
    document.getElementById("cancelModal").classList.add("flex");
}

function closeCancelModal() {
    document.getElementById("cancelModal").classList.add("hidden");
    document.getElementById("cancelModal").classList.remove("flex");
}
document.querySelectorAll('input[name="cancel_reason"]').forEach(radio => {
    radio.addEventListener('change', () => {
        document.getElementById('confirmBtn').disabled = false;
    });
});
</script>

{% endblock %}
