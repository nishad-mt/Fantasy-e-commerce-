{% extends 'dashboard.html' %}
{% block title %}
    <title>Products Management | Fantasy Bakery Admin</title>
{% endblock %}   
{% block content %}
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#fff7ed',
                            100: '#ffedd5',
                            200: '#fed7aa',
                            300: '#fdba74',
                            400: '#fb923c',
                            500: '#f97316', // Orange-500
                            600: '#ea580c',
                            700: '#c2410c',
                            800: '#9a3412',
                            900: '#7c2d12',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Scrollbar for Table */
        .custom-scrollbar::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #d4d4d8;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a1a1aa;
        }
        
        /* Modal Transition */
        .modal {
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease-in-out;
        }
        .modal.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            transform: scale(0.95);
            transition: all 0.3s ease-in-out;
        }
        .modal.active .modal-content {
            transform: scale(1);
        }
    </style>
<!-- Main Container -->
    <div class="min-h-screen p-4 md:p-8 max-w-7xl mx-auto space-y-8">

        <!-- 1. Page Header -->
        <header class="flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Products Management</h1>
                <p class="text-gray-500 mt-1">Manage all products, pricing, and visibility</p>
            </div>
            <a href="{% url 'add_products' %}" onclick="openModal('add')" class="bg-brand-500 hover:bg-brand-600 text-white px-5 py-2.5 rounded-lg shadow-sm hover:shadow-md transition-all flex items-center gap-2 font-medium">
                <i class="fa-solid fa-plus"></i> Add Product
            </a>
        </header>

        <!-- 2. Stats Cards -->
        <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
            <!-- Total Products -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between">
                <div>
                    <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Total Products</p>
                    <p class="text-2xl font-bold text-gray-800 mt-1">{{ total_product }}</p>
                </div>
                <div class="w-10 h-10 bg-blue-50 text-blue-500 rounded-full flex items-center justify-center">
                    <i class="fa-solid fa-box-open"></i>
                </div>
            </div>
            
            <!-- Active -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between">
                <div>
                    <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Active</p>
                    <p class="text-2xl font-bold text-green-600 mt-1">{{ active_product_count }}</p>
                </div>
                <div class="w-10 h-10 bg-green-50 text-green-500 rounded-full flex items-center justify-center">
                    <i class="fa-solid fa-check-circle"></i>
                </div>
            </div>
            
            <!-- Out of Stock -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between">
                <div>
                    <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Out of Stock</p>
                    <p class="text-2xl font-bold text-red-500 mt-1">{{ outof_stock_count }}</p>
                </div>
                <div class="w-10 h-10 bg-red-50 text-red-500 rounded-full flex items-center justify-center">
                    <i class="fa-solid fa-triangle-exclamation"></i>
                </div>
            </div>
            
            <!-- Featured -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between">
                <div>
                    <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Featured</p>
                    <p class="text-2xl font-bold text-brand-600 mt-1">24</p>
                </div>
                <div class="w-10 h-10 bg-brand-50 text-brand-500 rounded-full flex items-center justify-center">
                    <i class="fa-solid fa-star"></i>
                </div>
            </div>

            <!-- Discounts -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between">
                <div>
                    <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Discounts</p>
                    <p class="text-2xl font-bold text-purple-600 mt-1">150</p>
                </div>
                <div class="w-10 h-10 bg-purple-50 text-purple-500 rounded-full flex items-center justify-center">
                    <i class="fa-solid fa-tags"></i>
                </div>
            </div>
        </section>

       <!-- 3. Filters & Search -->
<section class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col lg:flex-row gap-4 justify-between items-center">
    
    <!-- Search Form -->
    <form method="GET" class="relative w-full lg:w-96">
        <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
        <input type="text" name="q" value="{{ query }}" 
            placeholder="Search product name or SKU..." 
            class="w-full pl-10 pr-8 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-200 focus:border-brand-500 transition-all text-sm">
        
        {% if query %}
            <button type="submit" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-brand-500">
                <i class="fa-solid fa-magnifying-glass"></i>
            </button>
            <a href="{% url 'admin_products' %}" class="absolute right-10 top-1/2 -translate-y-1/2 text-xs text-gray-500 hover:text-gray-700 underline">Clear</a>
        {% else %}
            <button type="submit" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-brand-500">
                <i class="fa-solid fa-magnifying-glass"></i>
            </button>
        {% endif %}
        
        <!-- Preserve other filters in search form -->
        {% for key, value in request.GET.items %}
            {% if key != 'q' %}
                <input type="hidden" name="{{ key }}" value="{{ value }}">
            {% endif %}
        {% endfor %}
    </form>

    <!-- Filters Group - Single Form for All Filters -->
    <form method="GET" class="flex flex-wrap gap-2 w-full lg:w-auto items-end">
        <!-- Category Filter -->
        <select name="categories" class="px-3 py-2 border border-gray-200 rounded-lg text-sm text-gray-600 focus:outline-none focus:border-brand-500 bg-white">
            <option value="">All Categories</option>
            {% for cat in category %}
                <option value="{{ cat.slug }}" {% if request.GET.categories == cat.slug %}selected{% endif %}>
                    {{ cat.name }}
                </option>
            {% endfor %}
        </select>

        <!-- Stock Filter -->
        <select name="stock" class="px-3 py-2 border border-gray-200 rounded-lg text-sm text-gray-600 focus:outline-none focus:border-brand-500 bg-white">
            <option value="">All Stock</option>
            <option value="in" {% if request.GET.stock == 'in' %}selected{% endif %}>In Stock</option>
            <option value="out" {% if request.GET.stock == 'out' %}selected{% endif %}>Out of Stock</option>
        </select>

        <!-- Price Filter -->
        <select name="price" class="px-3 py-2 border border-gray-200 rounded-lg text-sm text-gray-600 focus:outline-none focus:border-brand-500 bg-white">
            <option value="">Any Price</option>
            <option value="low" {% if request.GET.price == 'low' %}selected{% endif %}>Below â‚¹50</option>
            <option value="med" {% if request.GET.price == 'med' %}selected{% endif %}>Price: Low to High</option>
            <option value="high" {% if request.GET.price == 'high' %}selected{% endif %}>Price: High to Low</option>
        </select>

        <!-- Discount Filter -->
        <select name="discount" class="px-3 py-2 border border-gray-200 rounded-lg text-sm text-gray-600 focus:outline-none focus:border-brand-500 bg-white">
            <option value="">All Discounts</option>
            <option value="yes" {% if request.GET.discount == 'yes' %}selected{% endif %}>Has Discount</option>
            <option value="no" {% if request.GET.discount == 'no' %}selected{% endif %}>No Discount</option>
        </select>

        <!-- Preserve search query -->
        {% if query %}
            <input type="hidden" name="q" value="{{ query }}">
        {% endif %}

        <!-- Apply Button -->
        <button type="submit" class="px-4 py-2 bg-brand-500 text-white rounded-lg text-sm hover:bg-brand-600 transition-all flex items-center gap-1">
            <i class="fa-solid fa-filter"></i> Apply Filters
        </button>

        <!-- Clear All Button -->
        <a href="{% url 'admin_products' %}" class="px-4 py-2 border border-gray-200 rounded-lg text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 bg-gray-50 flex items-center gap-1">
            <i class="fa-solid fa-filter-circle-xmark"></i> Clear All
        </a>
    </form>
</section>

<!-- Search Results Notification -->
{% if query %}
<div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
    <p class="text-sm text-blue-800">
        <i class="fa-solid fa-search mr-2"></i>
        Found {{ page_obj.paginator.count }} products for "<strong>{{ query }}</strong>"
        {% if page_obj.has_previous or page_obj.has_next %}
            (Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }})
        {% endif %}
    </p>
</div>
{% endif %}


        <!-- 4. Products Table -->
        <section class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="overflow-x-auto custom-scrollbar max-h-[600px]">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-50 sticky top-0 z-10">
                        <tr>
                            <th class="p-4 text-xs font-semibold text-gray-500 uppercase tracking-wide border-b">Product</th>
                            <th class="p-4 text-xs font-semibold text-gray-500 uppercase tracking-wide border-b">SKU</th>
                            <th class="p-4 text-xs font-semibold text-gray-500 uppercase tracking-wide border-b">Category</th>
                            <th class="p-4 text-xs font-semibold text-gray-500 uppercase tracking-wide border-b">Price / Size_name</th>
                            <th class="p-4 text-xs font-semibold text-gray-500 uppercase tracking-wide border-b">Stock/Visibility</th>
                            <th class="p-4 text-xs font-semibold text-gray-500 uppercase tracking-wide border-b">Date</th>
                            <th class="p-4 text-xs font-semibold text-gray-500 uppercase tracking-wide border-b text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        <!-- Item 1 -->
                         {% for product in items %}
                        <tr class="hover:bg-gray-50 transition-colors">
                            <td class="p-4">
                                <div class="flex flex-col items-center gap-1">
    <div class="h-12 w-12 rounded-lg bg-gray-100 overflow-hidden border border-gray-200">
        <a href="{% url 'product_image' slug=product.slug %}">
        <img src="{{ product.main_image.url }}" alt="{{product.name}}" class="h-full w-full object-cover"></a>
    </div>
    <span class="text-xs text-gray-600 truncate">{{ product.name }}</span>
</div>

                            </td>
                            <td class="p-4 text-sm text-gray-600">{{ product.sku }}</td>
                            <td class="p-4 text-sm text-gray-600">{{ product.category.name}}</td>
                            <td class="p-4 text-sm font-medium text-gray-900">{{ product.min_price }}
                                <span class="text-xs text-gray-600 truncate"> / {{ product.min_size }}</span></td>

                            <td class="p-4">
                                {% if product.is_active == True%}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-50 text-green-700 border border-green-100">
                                    <span class="w-1.5 h-1.5 mr-1.5 bg-green-500 rounded-full"></span> In Stock
                                </span>
                                {% else %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-50 text-red-700 border border-red-100">
                                    <span class="w-1.5 h-1.5 mr-1.5 bg-red-500 rounded-full"></span> Out of Stock
                                </span>
                                {% endif %}
                            </td>
                            <td class="p-4 text-sm text-gray-500">{{ product.created_at}}</td>
                            <td class="p-4 text-right">
                                <div class="flex items-center justify-end gap-2">
                                    
                                    <a href="{% url 'edit_product' product.slug %}" 
                                    class="text-gray-400 hover:text-brand-500 transition-colors p-1" title="Edit">
                                        <i class="fa-solid fa-pen"></i>
                                    </a>
                                    <a href="{% url 'del_products' product.product_id %}" class="text-gray-400 hover:text-red-500 transition-colors p-1" title="Delete">
                                        <i class="fa-solid fa-trash"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <!-- <div class="px-4 py-3 border-t border-gray-100 flex items-center justify-between">
                <span class="text-sm text-gray-500">Showing 1-3 of 12 Products</span>
                <div class="flex gap-2">
                    <button class="px-3 py-1 text-sm border border-gray-200 rounded-md text-gray-500 disabled:opacity-50 hover:bg-gray-50" disabled>Previous</button>
                    <button class="px-3 py-1 text-sm border border-gray-200 rounded-md text-gray-500 hover:bg-gray-50">Next</button>
                </div>
            </div> -->
        </section>

        <!-- 6. Latest & Trending (Read-Only) -->
        <section class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Latest Products -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <h3 class="font-bold text-gray-900 text-lg mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-clock-rotate-left text-brand-500"></i> Recently Added
                </h3>
                <div class="space-y-4">
                    {% for rec in recently_added %}
                    <div class="flex items-center gap-3">
                        <img src="{{ rec.main_image.url }}" class="h-10 w-10 rounded object-cover">
                        <div class="flex-1">
                            <p class="text-sm font-medium text-gray-900">{{rec.name}}</p>
                            <p class="text-xs text-gray-500">{{ rec.created_at }}</p>
                        </div>
                        <span class="text-sm font-semibold text-gray-900">{{rec.base_price}}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Trending Products -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <h3 class="font-bold text-gray-900 text-lg mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-fire text-orange-500"></i> Trending Now
                </h3>
                <div class="space-y-4">
                    <div class="flex items-center justify-between border-b border-dashed border-gray-100 pb-2">
                        <span class="text-sm font-medium text-gray-900">1. Chocolate Truffle Cake</span>
                        <span class="text-xs font-semibold bg-orange-100 text-orange-700 px-2 py-1 rounded-full">120 Orders</span>
                    </div>
                    <div class="flex items-center justify-between border-b border-dashed border-gray-100 pb-2">
                        <span class="text-sm font-medium text-gray-900">2. Red Velvet Cupcake</span>
                        <span class="text-xs font-semibold bg-orange-100 text-orange-700 px-2 py-1 rounded-full">98 Orders</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-gray-900">3. Almond Croissant</span>
                        <span class="text-xs font-semibold bg-orange-100 text-orange-700 px-2 py-1 rounded-full">85 Orders</span>
                    </div>
                </div>
            </div>
        </section>

    </div>

    <!-- 5. Product Detail / Edit Modal -->
    <div id="productModal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
        <div class="modal-content bg-white w-full max-w-3xl max-h-[90vh] rounded-2xl shadow-2xl overflow-hidden flex flex-col">
            
            <!-- Modal Header -->
            <div class="flex justify-between items-center p-6 border-b border-gray-100">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800" id="modalTitle">Edit Product</h2>
                    <p class="text-sm text-gray-500">Update product details and inventory.</p>
                </div>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>

            <!-- Modal Body (Scrollable) -->
            <div class="flex-1 overflow-y-auto p-6">
                <form id="productForm" class="space-y-6">
                    
                    <!-- Basic Info -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label class="text-sm font-medium text-gray-700">Product Name</label>
                            <input type="text" value="Chocolate Truffle Cake" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-200 focus:border-brand-500 outline-none transition-all">
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-medium text-gray-700">SKU</label>
                            <input type="text" value="CK-2023-001" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-200 focus:border-brand-500 outline-none transition-all">
                        </div>
                    </div>

                    <!-- Category & Price -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="space-y-2">
                            <label class="text-sm font-medium text-gray-700">Category</label>
                            <select class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-200 focus:border-brand-500 outline-none bg-white">
                                <option>Cakes</option>
                                <option>Pastries</option>
                                <option>Cookies</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-medium text-gray-700">Price ($)</label>
                            <input type="number" value="45.00" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-200 focus:border-brand-500 outline-none">
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-medium text-gray-700">Stock Qty</label>
                            <input type="number" value="12" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-200 focus:border-brand-500 outline-none">
                        </div>
                    </div>

                    <!-- Description -->
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-gray-700">Description</label>
                        <textarea rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-200 focus:border-brand-500 outline-none">Delicious dark chocolate truffle cake with rich ganache.</textarea>
                    </div>

                    <!-- Toggles -->
                    <div class="flex flex-wrap gap-8 p-4 bg-gray-50 rounded-lg border border-gray-100">
                        <label class="flex items-center cursor-pointer gap-3">
                            <div class="relative">
                                <input type="checkbox" class="sr-only peer" checked>
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                            </div>
                            <span class="text-sm font-medium text-gray-700">Active Visibility</span>
                        </label>

                        <label class="flex items-center cursor-pointer gap-3">
                            <div class="relative">
                                <input type="checkbox" class="sr-only peer" checked>
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-brand-500"></div>
                            </div>
                            <span class="text-sm font-medium text-gray-700">Featured Product</span>
                        </label>
                    </div>

                    <!-- Image Upload Demo -->
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-gray-700">Product Images</label>
                        <div class="flex items-center justify-center w-full">
                            <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition-colors">
                                <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                    <i class="fa-solid fa-cloud-arrow-up text-3xl text-gray-400 mb-2"></i>
                                    <p class="text-sm text-gray-500"><span class="font-semibold">Click to upload</span> or drag and drop</p>
                                    <p class="text-xs text-gray-500">PNG, JPG up to 10MB</p>
                                </div>
                                <input type="file" class="hidden" />
                            </label>
                        </div>
                    </div>

                </form>
            </div>

            <!-- Modal Footer -->
            <div class="p-6 border-t border-gray-100 bg-gray-50 flex justify-end gap-3">
                <button onclick="closeModal()" class="px-5 py-2.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 shadow-sm transition-colors">Cancel</button>
                <button onclick="saveProduct()" class="px-5 py-2.5 text-sm font-medium text-white bg-brand-500 rounded-lg hover:bg-brand-600 shadow-sm hover:shadow transition-colors">Save Changes</button>
            </div>
        </div>
    </div>
<script>
document.querySelector('input[name="q"]').addEventListener('input', function() {
    let query = this.value;
    let form = this.closest('form');
    
    // Debounce (wait 300ms after typing stops)
    clearTimeout(this.timeout);
    this.timeout = setTimeout(() => {
        if (query.length > 2 || query.length === 0) {
            form.submit();
        }
    }, 300);
});
</script>

    <!-- <script>
        const modal = document.getElementById('productModal');
        const modalTitle = document.getElementById('modalTitle');

        function openModal(mode) {
            modal.classList.add('active');
            if (mode === 'add') {
                modalTitle.innerText = "Add New Product";
                // Reset form logic here
            } else if (mode === 'edit') {
                modalTitle.innerText = "Edit Product";
                // Populate form logic here
            } else if (mode === 'view') {
                 modalTitle.innerText = "Product Details";
                 // Read-only logic here
            }
        }

        function closeModal() {
            modal.classList.remove('active');
        }

        function saveProduct() {
            // Mock save
            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';
            setTimeout(() => {
                btn.innerText = originalText;
                closeModal();
                alert('Product saved successfully! (Demo)');
            }, 800);
        }

        // Close modal on outside click
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeModal();
            }
        });
    </script> -->
{% endblock %}
