{% extends 'index.html' %}
{% load static %}

{% block title %}{{ product.name|default:"Fantasy_bakery" }} | Fantasy Bakery{% endblock %}

{% block content %}

<div class="bg-fantasy-cream py-4 pt-28">
    <div class="container mx-auto px-6">
        <nav class="text-sm font-medium text-gray-500">
            <a href="{% url 'home' %}" class="hover:text-fantasy-brown transition-colors">Home</a>
            <span class="mx-2">/</span>
            <a href="{% url 'products_by_category' product.category.slug %}" class="hover:text-fantasy-brown transition-colors">{{ product.category }}</a>
            <span class="mx-2">/</span>
            <span class="text-fantasy-brown font-bold">{{ product.name|default:"Fantasy Foods" }}</span>
        </nav>
    </div>
</div>

<!-- Product Hero Section -->
<section class="py-12 bg-white">
    <div class="container mx-auto px-6">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-12">
            <!-- Product Images Gallery (Reduced Size: 5 cols instead of 6/half) -->
            <div class="lg:col-span-5 space-y-4">
                <div class="relative overflow-hidden rounded-2xl shadow-lg bg-gray-50 aspect-square group">
                    <img id="main-product-image"
                        src="{{ product.main_image.url }}"
                        alt="Product Image"
                        class="w-full h-full object-cover transform group-hover:scale-110 transition-transform duration-700 cursor-zoom-in">

                    <!-- Discount Badge -->
                    <!-- <span
                        class="absolute top-4 left-4 bg-fantasy-pink-dark text-white text-sm font-bold px-3 py-1 rounded-full shadow-md">
                        20% OFF
                    </span> -->

                    <!-- Wishlist Button -->
                    <form method="POST" action="{% url 'wishlist:toggle_wishlist' product.product_id %}">
                        {% csrf_token %}
                        <button
                            type="submit"class="absolute top-3 right-3 z-10 w-8 h-8 bg-white/80 backdrop-blur
                            rounded-full flex items-center justify-center transition-all shadow-sm
                            {% if product.product_id in wishlist_product_ids %}
                                text-red-500
                            {% else %}
                                text-gray-400 hover:text-red-500
                            {% endif %}">
                            <i class="fa-solid fa-heart"></i>
                        </button>
                    </form>
               </div>

                <!-- Thumbnails -->
                <div class="flex gap-4 overflow-x-auto pb-2 hide-scrollbar">
                    <button 
                    onclick="updateMainImage('{{ product.main_image.url }}', this)"
                        class="relative w-20 h-20 flex-shrink-0 rounded-xl overflow-hidden border-2 border-fantasy-gold shadow-sm">
                        <img src="{{ product.main_image.url }}"
                            class="w-full h-full object-cover">
                    </button>
                    {% for img in images %}
                    <button 
                    onclick="updateMainImage('{{ img.image.url }}', this)"
                        class="relative w-20 h-20 flex-shrink-0 rounded-xl overflow-hidden border-2 border-fantasy-gold shadow-sm">
                        <img src="{{ img.image.url }}"
                            class="w-full h-full object-cover">
                    </button>
                    {% endfor %}
                </div>
            </div>

            <!-- Product Details (Expanded Size: 7 cols) -->
            <div class="lg:col-span-7 flex flex-col h-full">
                <div class="mb-2">
                    <span class="text-fantasy-gold font-bold uppercase tracking-wider text-xs">{{ product.category}}</span>
                </div>

                <h1 class="text-4xl md:text-5xl font-serif font-bold text-fantasy-brown mb-4 leading-tight">
                    {{ product.name|default:"Fantasy Foods" }}
                </h1>

                <!-- Ratings -->
                <div class="flex items-center gap-4 mb-6">
                    <div class="flex text-yellow-400 text-sm">
                        {% for i in "12345" %}
                                {% if forloop.counter <= avg_rating %}
                                    <i class="fa-solid fa-star"></i>
                                {% elif forloop.counter <= avg_rating|add:"0.5" %}
                                    <i class="fa-solid fa-star-half-stroke"></i>
                                {% else %}
                                    <i class="fa-regular fa-star"></i>
                                {% endif %}
                        {% endfor %}
                    </div>
                    <span class="text-gray-500 text-sm font-medium border-l border-gray-300 pl-4">
                        {{ avg_rating|floatformat:1 }} ({{review_count}} reviews)
                    </span>
                    {% if product.is_active %}
                    <span class="text-green-600 text-sm font-bold bg-green-50 px-2 py-0.5 rounded-full">
                        In Stock
                    </span>
                    {% else %}
                    <span class="text-red-600 text-sm font-bold bg-red-50 px-2 py-0.5 rounded-full">
                        Out Of Stock
                    </span>
                    {% endif %}
                </div>

                <!-- Price -->
                <div class="flex items-end gap-3 mb-6 bg-fantasy-cream/50 p-4 rounded-xl inline-block w-max">
                    <span class="text-4xl font-bold text-fantasy-brown" id="product-price">{{ initial_variant.price }}</span>
                    <span id= "product-mrp" class="text-xl text-gray-400 line-through mb-1">{{ initial_variant.price }}</span>
                </div>

                <p class="text-gray-600 leading-relaxed mb-8 text-lg">
                    {{ product.description }}
                </p>

                <!-- Variants -->
                {% if has_variants %}
                <div class="mb-8">
                    <h3 class="font-bold text-fantasy-brown mb-3">Choose Weight</h3>
                    <div class="flex flex-wrap gap-3" id="variant-selector">
                        {% for var in variants %}
                        <button type="button"
                            class="variant-btn px-6 py-2 rounded-full border-2 border-gray-200 text-gray-600 transition-all font-medium"
                            data-price="{{ var.price }}"
                            data-mrp="{{ var.price|add:29 }}" 
                            data-variant-id="{{ var.id }}"
                            onclick="selectVariant(this)">
                            {{ var.size_name }}
                        </button>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Actions -->
                <div class="flex flex-col sm:flex-row gap-4 mb-8">
                    <!-- Quantity -->
                    <div class="flex items-center border-2 border-gray-200 rounded-full h-14 w-max px-2">
                        <button onclick="updateQuantity(-1)"
                            class="w-10 h-10 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-100 hover:text-fantasy-brown transition-colors">
                            <i class="fa-solid fa-minus"></i>
                        </button>
                        <input type="text" value="1" id="quantity-input"
                            class="w-12 text-center font-bold text-fantasy-brown bg-transparent focus:outline-none"
                            readonly>
                        <button onclick="updateQuantity(1)"
                            class="w-10 h-10 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-100 hover:text-fantasy-brown transition-colors">
                            <i class="fa-solid fa-plus"></i>
                        </button>
                    </div>

                        <!-- Add to Cart -->
                        <form method="POST" action="{% url 'cart:toggle_cart' 0 %}" id="addToCartForm">
                            {% csrf_token %}

                            <input type="hidden" name="variant_id" id="selectedVariantInput">
                            <input type="hidden" name="quantity" id="quantityHidden" value="1">

                            <button type="submit"
                                id="addToCartBtn"
                                class="flex-1 min-w-[240px] h-14 rounded-full bg-fantasy-brown
                                    text-white font-semibold text-lg transition-all duration-300 ease-out hover:bg-fantasy-gold hover:text-fantasy-brown
                                hover:shadow-xl hover:-translate-y-0.5 active:translate-y-0 active:shadow-md">
                                <i class="fa-solid fa-cart-plus"></i> Add to Cart
                            </button>
                        </form>

                    <!-- Buy Now -->
                    <form method="POST"action="{% url 'buy_now' initial_variant.id %}"
                        class="flex-1">
                        {% csrf_token %}
                        <input type="hidden" name="quantity" id="buyNowQuantity" value="1">
                        <button
                            class="w-full h-14 rounded-full font-semibold text-lg bg-fantasy-brown text-white
                                transition-all duration-300 ease-out hover:bg-fantasy-gold hover:text-fantasy-brown
                                hover:shadow-xl hover:-translate-y-0.5 active:translate-y-0 active:shadow-md">
                            Buy Now
                        </button>
                    </form>

                </div>

                <!-- Coupon & Delivery -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 p-6 bg-gray-50 rounded-2xl border border-gray-100">
                    <!-- Delivery Check -->
                    <div>
                        <h4 class="font-bold text-fantasy-brown mb-2 text-sm flex items-center gap-2">
                            <i class="fa-solid fa-truck-fast text-fantasy-gold"></i> Delivery Availability
                        </h4>
                        <div class="relative">
                            <input type="text" placeholder="Enter Pincode"
                                class="w-full pl-4 pr-20 py-2.5 rounded-lg border border-gray-200 focus:outline-none focus:border-fantasy-brown focus:ring-1 focus:ring-fantasy-brown text-sm">
                            <button
                                class="absolute right-1 top-1 bottom-1 px-4 bg-fantasy-brown text-white rounded-md text-xs font-bold hover:bg-opacity-90">Check</button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2"><i class="fa-regular fa-clock mr-1"></i> Order now for
                            delivery by <span class="font-bold text-gray-700">Tomorrow, 4 PM</span></p>
                    </div>

                    <!-- Coupon -->
                    <div>
                        <h4 class="font-bold text-fantasy-brown mb-2 text-sm flex items-center gap-2">
                            <i class="fa-solid fa-tag text-fantasy-gold"></i> Apply Coupon
                        </h4>
                        <div class="relative">
                            <input type="text" placeholder="Promo Code"
                                class="w-full pl-4 pr-20 py-2.5 rounded-lg border border-gray-200 focus:border-dashed focus:border-fantasy-brown focus:outline-none text-sm uppercase">
                            <button
                                class="absolute right-1 top-1 bottom-1 px-4 text-fantasy-brown font-bold text-xs hover:bg-fantasy-cream rounded-md transition-colors">APPLY</button>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</section>

<!-- Description & Reviews Sections (Stacked) -->
<section class="bg-fantasy-cream border-t border-fantasy-brown/10">
    <div class="container mx-auto px-6 max-w-5xl">


        <!-- Reviews Content (Stacked Below Description) -->
        <div class="py-16">
            <h3 class="text-3xl font-serif font-bold text-fantasy-brown mb-12 text-center">Customer Reviews ({{review_count}})</h3>

            <div class="grid md:grid-cols-3 gap-12">
                <!-- Summary -->
                <div class="md:col-span-1">
                    <div class="bg-white p-6 rounded-2xl shadow-sm text-center sticky top-24">
                        <h4 class="text-5xl font-bold text-fantasy-brown mb-2">{{ avg_rating|floatformat:1 }}</h4>
                        <div class="text-yellow-400 text-xl mb-2">
                            {% for i in "12345" %}
                                {% if forloop.counter <= avg_rating %}
                                    <i class="fa-solid fa-star"></i>
                                {% elif forloop.counter <= avg_rating|add:"0.5" %}
                                    <i class="fa-solid fa-star-half-stroke"></i>
                                {% else %}
                                    <i class="fa-regular fa-star"></i>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <p class="text-gray-500 text-sm mb-6">Based on {{review_count}} reviews</p>

                        {% if user.is_authenticated %}
                                <a href="{% url 'write_review' product.slug %}">
                                    <button
                                        class="w-full mt-6 py-2 border border-fantasy-brown text-fantasy-brown font-bold rounded-lg
                                            hover:bg-fantasy-brown hover:text-white transition-colors">
                                        Write a Review
                                    </button>
                                </a>
                            {% else %}
                                <a href="{% url 'login' %}?next={% url 'write_review' product.slug %}"
                                class="block w-full mt-6 py-2 border border-gray-300 text-gray-500 font-bold rounded-lg
                                        hover:bg-gray-50 transition-colors text-center">
                                    Login to Review
                                </a>
                            {% endif %}

                    </div>
                </div>

                <!-- Review List & Form -->
                <div class="md:col-span-2 space-y-6">

                    <!-- Review Form (Hidden initially) -->
                    <div id="review-form"
                        class="hidden bg-gray-50 p-6 rounded-2xl border border-gray-200 mb-6 animate-fade-in-up">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="font-bold text-fantasy-brown">Write your review</h4>
                            <button onclick="document.getElementById('review-form').classList.add('hidden')"
                                class="text-gray-400 function hover:text-gray-600"><i
                                    class="fa-solid fa-xmark"></i></button>
                        </div>
                        <form method="POST" action="{% url 'write_review' product.slug %}">
                        {% csrf_token %}
                            <div class="mb-4">
                                <label class="block text-sm font-bold text-gray-700 mb-2">Rating</label>
                                <div class="flex gap-2 text-2xl text-gray-300 hover:text-yellow-400 cursor-pointer">
                                    <i class="fa-solid fa-star hover:text-yellow-400"></i>
                                    <i class="fa-solid fa-star hover:text-yellow-400"></i>
                                    <i class="fa-solid fa-star hover:text-yellow-400"></i>
                                    <i class="fa-solid fa-star hover:text-yellow-400"></i>
                                    <i class="fa-solid fa-star hover:text-yellow-400"></i>
                                </div>
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-bold text-gray-700 mb-2">Your Review</label>
                                <textarea rows="4"
                                    class="w-full rounded-lg border-gray-200 p-3 focus:ring-fantasy-brown focus:border-fantasy-brown"
                                    placeholder="What did you like or dislike?"></textarea>
                            </div>
                            <button type="submit"
                                class="bg-fantasy-brown text-white px-6 py-2 rounded-lg font-bold hover:bg-opacity-90">Submit
                                Review</button>
                        </form>
                    </div>

                        {% for r in product.reviews.all %}
                            {% if r.is_approved %}
                            <div class="review-item {% if forloop.counter > 2 %}hidden extra-review{% endif %}
                                bg-white p-6 rounded-2xl shadow-sm border border-gray-100">

                                <div class="flex justify-between items-start mb-4">

                                    <!-- Left: Avatar + Name -->
                                    <div class="flex items-center gap-4">
                                        <div class="w-10 h-10 rounded-full bg-fantasy-gold/20 flex items-center justify-center text-fantasy-brown font-bold">
                                            {{ r.user.username|slice:":2"|upper }}
                                        </div>
                                        <div>
                                            <h5 class="font-bold text-gray-800">
                                                {{ r.user.get_full_name|default:r.user.username }}
                                            </h5>

                                            <div class="text-yellow-400 text-xs">
                                                {% for i in "12345" %}
                                                    {% if forloop.counter <= r.rating %}
                                                        <i class="fa-solid fa-star"></i>
                                                    {% else %}
                                                        <i class="fa-regular fa-star"></i>
                                                    {% endif %}
                                                {% endfor %}
                                            </div>

                                            {% if r.is_verified_purchase %}
                                                <span class="text-xs text-green-600 font-medium">
                                                    Verified Purchase
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <!-- Right: Time + Actions -->
                                    <div class="text-right">
                                        <span class="block text-xs text-gray-400">
                                            {{ r.created_at|timesince }} ago
                                        </span>

                                        {% if r.user == request.user or request.user.is_staff %}
                                        <div class="flex gap-3 text-xs mt-2 justify-end">
                                            <a href="{% url 'edit_review' r.review_id %}"
                                            class="text-blue-500 hover:underline">
                                                Edit
                                            </a>
                                            <a href="{% url 'delete_review' r.review_id %}"
                                            class="text-red-500 hover:underline"
                                            onclick="return confirm('Delete this review?');">
                                                Delete
                                            </a>
                                        </div>
                                        {% endif %}
                                    </div>

                                </div>

                                <p class="text-gray-600">{{ r.review }}</p>
                            </div>
                            {% endif %}
                        {% endfor %}
                        {% if review_count > 2 %}
                        <button id="viewMoreBtn"
                            class="mt-4 text-fantasy-brown font-semibold text-sm hover:underline">
                            View more reviews
                        </button>
                        {% endif %}

                </div>
            </div>
        </div>
    </div>
</section>

<!-- Related Products -->
<section class="py-16 bg-white">
    <div class="container mx-auto px-6">
        <h2 class="text-3xl font-serif font-bold text-fantasy-brown mb-8 text-center">You Might also like</h2>

        <div class="grid grid-cols-2 md:grid-cols-5 gap-6">
            <!-- Card 1 -->
             {% for latest in latest_products %}
            <div class="group cursor-pointer">
                <div class="relative overflow-hidden rounded-xl bg-gray-100 aspect-[4/5] mb-3">
                    <img src="{{ latest.main_image.url }}"
                        class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500">
                    <button
                        class="absolute bottom-3 right-3 bg-white p-2 rounded-full shadow-md text-fantasy-brown hover:text-white hover:bg-fantasy-brown transition-all opacity-0 group-hover:opacity-100 transform translate-y-2 group-hover:translate-y-0">
                        <i class="fa-solid fa-cart-plus"></i>
                    </button>
                </div>
                <h3 class="font-bold text-gray-800 text-sm group-hover:text-fantasy-gold transition-colors">
                    {{ latest.name }}
                </h3>
                <span class="font-bold text-fantasy-brown">₹{{ latest.starting_price}}</span>
            </div>
            {% endfor %}
        </div>
    </div>
</section>

<!-- Page Specific Scripts -->
<script>
    // Image Gallery
    function updateMainImage(src) {
        const mainImage = document.getElementById('main-product-image');
        // Simple fade effect
        mainImage.style.opacity = '0.5';
        setTimeout(() => {
            mainImage.src = src;
            mainImage.style.opacity = '1';
        }, 150);

        // Update active state of thumbnails (optional visual enhancement)
        // ... code to toggle active class on clicked thumb
    }

    // Variant Selection & Price Update
function selectVariant(btn) {
    // Reset all buttons
    document.querySelectorAll('.variant-btn').forEach(b => {
        b.classList.remove(
            'bg-fantasy-brown',
            'text-white',
            'border-fantasy-brown',
            'shadow-md',
            'scale-105'
        );
        b.classList.add('text-gray-600', 'border-gray-200');
    });

    // Activate selected button
    btn.classList.remove('text-gray-600', 'border-gray-200');
    btn.classList.add(
        'bg-fantasy-brown',
        'text-white',
        'border-fantasy-brown',
        'shadow-md',
        'scale-105'
    );

    // Prices
    selectedPrice = parseFloat(btn.dataset.price);
    selectedMrp   = parseFloat(btn.dataset.mrp);

    const qty = parseInt(document.getElementById('quantity-input').value, 10);
    updateTotalPrice(qty);

    // ✅ CART FIX (CRITICAL)
    const variantId = btn.dataset.variantId;

    // set hidden input
    document.getElementById('selectedVariantInput').value = variantId;

    // update form action (/cart/toggle/<id>/)
    const form = document.getElementById('addToCartForm');
    form.action = `/cart/toggle/${variantId}/`;

    // enable button
    document.getElementById('addToCartBtn').disabled = false;
    document.getElementById('quantity-input').value = 1;
    document.getElementById('quantityHidden').value = 1;
    document.getElementById('buyNowQuantity').value = 1;

    updateTotalPrice(1);
}

    // Quantity Logic
let selectedMrp   = {{ initial_variant.price|add:29 }};
let quantity = 1;
let selectedPrice = {{ initial_variant.price }};   // updated when variant is selected
let maxQty = 10;         // can be dynamic from stock

function updateQuantity(change) {
    const input = document.getElementById('quantity-input');
    let qty = parseInt(input.value, 10);

    qty += change;
    if (qty < 1) qty = 1;
    if (qty > maxQty) qty = maxQty;

    input.value = qty;

    // ✅ sync quantity to form
    document.getElementById('quantityHidden').value = qty;
    document.getElementById('buyNowQuantity').value = qty;   

    updateTotalPrice(qty);
    toggleQtyButtons(qty);
}

function updateTotalPrice(qty) {
    const sellingTotal = selectedPrice * qty;
    const mrpTotal = selectedMrp * qty;

    document.getElementById('product-price').innerText =
        `₹${sellingTotal.toFixed(2)}`;

    document.getElementById('product-mrp').innerText =
        `₹${mrpTotal.toFixed(2)}`;
}


function toggleQtyButtons(qty) {
    const minusBtn = document.querySelector('[onclick="updateQuantity(-1)"]');
    const plusBtn  = document.querySelector('[onclick="updateQuantity(1)"]');

    minusBtn.classList.toggle('opacity-40', qty === 1);
    plusBtn.classList.toggle('opacity-40', qty === maxQty);

    minusBtn.disabled = qty === 1;
    plusBtn.disabled  = qty === maxQty;
}


    document.addEventListener("DOMContentLoaded", function () {
    const firstVariantBtn = document.querySelector('.variant-btn');

    if (firstVariantBtn) {
        selectVariant(firstVariantBtn);
    }
});
    
    setTimeout(() => {
        const msg = document.getElementById("cart-success");
        if (msg) msg.style.display = "none";
    }, 3000);

    document.getElementById("viewMoreBtn").addEventListener("click", function () {
    document.querySelectorAll(".extra-review").forEach(el => {
        el.classList.remove("hidden");
    });

    this.style.display = "none";
});
</script>
{% endblock %}